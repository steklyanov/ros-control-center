<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://static.robotwebtools.org/EaselJS/current/easeljs.js"></script>
    <script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
    <script src="https://static.robotwebtools.org/roslibjs/current/roslib.js"></script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="static/main.js"></script>
    <style>
        body {
            overflow: hidden;
        }
        .wrapper {
            width:100%;
            height:100vh;
            overflow: hidden;
            /*background-image: url(http://www.webestools.com/page/media/videoTag/BigBuckBunny.png);*/
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
        }

        .wrapper screen_content {
            object-fit: cover;
            width:100%;
            height:100%;
        }
        .button_group {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            margin-top: 120px;
        }
    </style>
</head>
<body>
    <div id="first_video_div" class="wrapper">
        <video id="first_video" width="920" height="500" src="" ></video>
    </div>
    <div class="button_group">
        <button id="btn1" type="button" onclick="second_stage()" class="btn btn-primary btn-lg" style="width: 250px; height: 150px"> Примите</button>
        <button id="btn2" type="button" onclick="second_stage()" class="btn btn-primary btn-lg" style="width: 250px; height: 150px"> Не примите </button>
        <button id="btn3" type="button" onclick="second_stage()" class="btn btn-primary btn-lg" style="width: 250px; height: 150px"> Сообщите в IOT</button>
        <button type="button" id="lid_control" class="btn btn-primary btn-lg" onclick="lid_button()">
            Получить подарок
        </button>
    </div>
    <script>
        let lid_action = Boolean;

        let videos = [
            "q1.mov",
            "q2.mov",
            "q3.mov",
            "q4.mov"
        ];
        let btn1 = document.getElementById('btn1');
        let btn2 = document.getElementById('btn2');
        let btn3 = document.getElementById('btn3');
        let lid = document.getElementById('lid_control');
        let video_container = document.getElementById('first_video');
        let video_frame = document.getElementById('first_video_div');
        lid.style.display='none';
        function disable_buttons_enable_video(src) {
            btn1.style.display='none';
            btn2.style.display='none';
            btn3.style.display='none';
            video_frame.style.display='block';
            video_container.setAttribute("src", src);
        }

        function enable_buttons_disable_video() {
            video_frame.style.display='none';
            btn1.style.display='block';
            btn2.style.display='block';
            btn3.style.display='block';
        }
        btn1.style.display='none';
        btn2.style.display='none';
        btn3.style.display='none';
        video_frame.style.display='block';
        video_container.setAttribute("src", videos[0]);
        video_container.load();


        function play_video() {
            video_container.play();
            video_container.addEventListener("ended", first_answer)
        }

        function first_answer() {
            enable_buttons_disable_video()
        }

        function second_stage() {
            disable_buttons_enable_video(videos[1]);
            video_container.play();
            video_container.addEventListener("ended", second_answer)
        }

        function second_answer() {
            btn1.setAttribute("onclick", 'third_stage()');
            btn2.setAttribute("onclick", 'third_stage()');
            btn3.setAttribute("onclick", 'third_stage()');
            btn1.innerHTML = 'С виртуальным ассистентом';
            btn2.innerHTML = 'С голосовым помощником';
            btn3.innerHTML = 'С кожанным промоботом';
            enable_buttons_disable_video();
        }

        function third_stage() {
            disable_buttons_enable_video(videos[2]);
            video_container.play();
            video_container.addEventListener("ended", third_answer)
        }

        function third_answer() {
            enable_buttons_disable_video();
            btn1.setAttribute("onclick", 'final()');
            btn2.setAttribute("onclick", 'final()');
            btn3.setAttribute("onclick", 'final()');
            btn1.innerHTML = 'Разобью его';
            btn2.innerHTML = 'Позволю ему ползти дальше';
            btn3.innerHTML = 'Замру пока он не улетит';
        }

        function final() {
            disable_buttons_enable_video(videos[3]);
            video_container.play();
            video_container.addEventListener("ended", to_lid)
        }
        function to_lid()
        {
            lid_action = false;
            btn1.style.display='none';
            btn2.style.display='none';
            btn3.style.display='none';
            lid.style.display='block';
        }

        document.onkeypress = function (event) {
            console.log(event);
            if (event.key == '1') {
                play_video();
            }
        };

        var ros = new ROSLIB.Ros({
            url : 'ws://localhost:9090'
        });

        function lid_button() {
            lid_action = !lid_action;
            lid_control(lid_action);
            const btn = document.querySelector('#lid_control');
            if (btn.classList.contains('btn-primary')) {
                btn.classList.add('btn-success');
                btn.classList.remove('btn-primary');
                btn.innerHTML = "Закрыть крышку";
            } else {
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-success');
                btn.innerHTML = "Открыть крышку";
            }

        }
        var listener = new ROSLIB.Topic({
            ros : ros,
            name : '/listener',
            messageType : 'std_msgs/Bool'
        });

        listener.subscribe(function(message) {
            if (message = 'true')
                play_video()
            // listener.unsubscribe();
        });
        // function topic() {
        //     var listener = new ROSLIB.Topic({
        //         ros : ros,
        //         name : '/listener',
        //         messageType : 'std_msgs/Bool'
        //     });
        //
        //     listener.subscribe(function(message) {
        //             play_video();
        //             listener.unsubscribe()
        //     });
        // }
        // topic()
        function lid_control(action) {

            var LidControl = new ROSLIB.Service({
                ros : ros,
                name : '/dynamixel_control_srv',
                serviceType : 'action_dynamixel/dynamixel_control'
            });

            var request = new ROSLIB.ServiceRequest({
                command : Boolean(action)
            });

            LidControl.callService(request, function(result) {
                console.log('Открыть крышку');
            });
        }
    </script>
</body>
</html>